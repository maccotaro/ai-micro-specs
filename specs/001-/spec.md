# 機能仕様: ナレッジベースのコレクション階層構造

**機能ブランチ**: `001-`
**作成日**: 2025-10-05
**ステータス**: ドラフト
**入力**: ユーザー説明: "現在のナレッジベースはナレッジベース直下にドキュメントがある構造ですが、ナレッジベース→コレクション→ドキュメントの構造に変更できますか？"

## Clarifications

### Session 2025-10-05

- Q: 1つのドキュメントは複数のコレクションに属することができますか、それとも1つのコレクションのみですか? → A: 単一コレクションのみ(1つのドキュメントは1つのコレクションにのみ所属)
- Q: コレクションが削除された場合、そのコレクション内のドキュメントはどうなりますか? → A: 削除前に確認を行い、ユーザーが「ドキュメントも削除」または「デフォルトコレクションに移動」を選択
- Q: コレクション内にサブコレクション(ネストされたコレクション)を作成できる必要がありますか? → A: 不要(1レベルのみ: ナレッジベース → コレクション → ドキュメント)
- Q: どのコレクションにも割り当てられていないドキュメントはどう扱いますか? → A: デフォルト/未分類コレクションが自動的に存在し、そこに表示される
- Q: ドキュメント検索機能はどのスコープで動作しますか? → A: 両方(デフォルトは全体検索、コレクション絞り込みオプションあり)

## 実行フロー (main)

```
1. ユーザー説明の解析
   → リクエスト: ナレッジベース構造をフラット型(ナレッジベース→ドキュメント)から
     階層型(ナレッジベース→コレクション→ドキュメント)に変更
2. 主要概念の抽出
   → アクター: ナレッジベースを管理するユーザー
   → アクション: ドキュメントをコレクションで整理
   → データ: ナレッジベース、コレクション、ドキュメント
   → 制約: 既存のドキュメント機能を維持
3. 不明確な点の特定:
   → [解決済: 既存ドキュメントはデフォルトコレクションに自動移行]
   → [解決済: 1つのドキュメントは1つのコレクションのみに所属]
   → [解決済: ネストされたコレクションは不要]
   → [解決済: コレクション削除時はユーザーが選択]
4. ユーザーシナリオ & テストセクションの記入
   → ユーザーがナレッジベース内にコレクションを作成
   → ユーザーがコレクション間でドキュメントを移動
   → ユーザーがコレクション別に整理されたドキュメントを閲覧
5. 機能要件の生成
   → システムはナレッジベース内でのコレクション作成をサポート
   → システムはドキュメントをコレクション内に整理可能
   → システムはドキュメントの関連性とメタデータを維持
6. 主要エンティティの特定
   → ナレッジベース(既存)
   → コレクション(新規中間エンティティ)
   → ドキュメント(既存、関連性を変更)
7. レビューチェックリストの実行
   → SUCCESS: 主要な不確定要素が明確化されました
8. 戻り値: SUCCESS (計画フェーズへ進む準備完了)
```

---

## ⚡ クイックガイドライン

- ✅ ユーザーが「何を」必要とし「なぜ」必要かに焦点を当てる
- ❌ 「どのように」実装するかは避ける(技術スタック、API、コード構造は記載しない)
- 👥 開発者ではなく、ビジネス関係者向けに記述

---

## ユーザーシナリオ & テスト

### 主要ユーザーストーリー

ナレッジベース管理者として、ドキュメントをコレクションに整理することで、ナレッジベース内の関連ドキュメントをより良く分類・管理し、ユーザーが関連コンテンツを見つけやすく、閲覧しやすくしたい。

### 受け入れシナリオ

1. **前提条件** コレクションのないナレッジベースを持っている、**操作** 「製品ドキュメント」という新しいコレクションを作成、**期待結果** コレクションがナレッジベースに表示され、ドキュメントを受け入れる準備ができている

2. **前提条件** ナレッジベースに「製品ドキュメント」コレクションがある、**操作** 新しいドキュメントをアップロード、**期待結果** 「製品ドキュメント」コレクションにドキュメントを割り当てられる

3. **前提条件** 「一般」コレクションにドキュメントがある、**操作** 「アーカイブ」コレクションに移動、**期待結果** ドキュメントは「一般」になくなり、「アーカイブ」に表示される

4. **前提条件** 10個のドキュメントを持つコレクションがある、**操作** コレクションを閲覧、**期待結果** 10個すべてのドキュメントがメタデータと共に表示される

5. **前提条件** ナレッジベースに複数のコレクションがある、**操作** ナレッジベースを閲覧、**期待結果** すべてのコレクションがドキュメント数と共に表示される

6. **前提条件** ドキュメントを含むコレクションがある、**操作** コレクション削除を試行、**期待結果** 確認ダイアログが表示され、「ドキュメントも削除」または「デフォルトコレクションに移動」を選択できる

7. **前提条件** ナレッジベース内に複数のコレクションとドキュメントがある、**操作** ナレッジベース全体を検索、**期待結果** すべてのコレクションからマッチするドキュメントが表示される

8. **前提条件** ナレッジベース内に複数のコレクションとドキュメントがある、**操作** 特定のコレクションを選択して検索、**期待結果** そのコレクション内のみからマッチするドキュメントが表示される

### エッジケース

- コレクションを削除する際、ドキュメントがある場合は確認ダイアログを表示し、ユーザーに「ドキュメントも削除」または「デフォルトコレクションに移動」の選択を求める
- 重複した名前でコレクションを作成しようとした場合、エラーメッセージを表示し作成を拒否する
- デフォルト/未分類コレクションは自動的に存在し、削除や名前変更はできない
- ナレッジベースあたりのコレクション数の上限は?
- コレクションあたりのドキュメント数の上限は?

## 要件

### 機能要件

- **FR-001**: システムはユーザーがナレッジベース内にコレクションを作成できなければならない
- **FR-002**: システムはユーザーが各コレクションに名前と任意の説明を設定できなければならない
- **FR-003**: システムはユーザーがコレクションにドキュメントを追加できなければならない
- **FR-004**: システムはユーザーがコレクション間でドキュメントを移動できなければならない
- **FR-005**: システムはユーザーがナレッジベース内のすべてのコレクションを閲覧できなければならない
- **FR-006**: システムは各コレクション内のドキュメント数を表示しなければならない
- **FR-007**: システムはユーザーが特定のコレクション内のすべてのドキュメントを閲覧できなければならない
- **FR-008**: システムはユーザーがコレクション名を変更できなければならない(デフォルトコレクションを除く)
- **FR-009**: システムはユーザーがコレクションを削除できなければならない。削除時にドキュメントが含まれる場合、確認ダイアログを表示し、「ドキュメントも削除」または「デフォルトコレクションに移動」の選択を求める
- **FR-010**: システムは既存のすべてのドキュメント機能(閲覧、編集、削除、OCR処理)を維持しなければならない
- **FR-011**: システムはドラッグ&ドロップUIでドキュメントを別のコレクションに移動できなければならない。ドラッグ操作中は以下のUXフィードバックを提供する:
  - **ドラッグ中**: ドラッグしているドキュメントを視覚的にハイライト表示
  - **ドロップ先**: ホバー時にドロップ可能なコレクションを視覚的に示す（ハイライトまたはボーダー変更）
  - **移動処理中**: ローディングスピナーまたは進行中表示
  - **成功**: 成功トーストメッセージを表示（例: 「ドキュメントを[コレクション名]に移動しました」）
  - **エラー**: エラートーストメッセージを表示し、元の位置に戻す
- **FR-012**: システムは1つのドキュメントが1つのコレクションにのみ所属することを保証しなければならない
- **FR-013**: システムはフラット構造(1レベル)のコレクションのみをサポートし、ネストされたコレクション(サブコレクション)は作成できない
- **FR-014**: システムはコレクション間でドキュメントを移動する際、ドキュメントの関連性とメタデータを保持しなければならない
- **FR-015**: システムは各ナレッジベースにデフォルト/未分類コレクションを自動的に作成し、コレクション未割り当てのドキュメントをそこに配置しなければならない
- **FR-016**: システムはナレッジベース内でコレクション名の一意性を検証しなければならない
- **FR-017**: システムはナレッジベース全体を横断する検索機能を提供し、オプションで特定のコレクションに絞り込めなければならない
- **FR-018**: システムはデフォルトコレクションの削除および名前変更を禁止しなければならない
- **FR-019**: システムは既存のドキュメントをデフォルトコレクションに自動的に移行しなければならない

### 主要エンティティ

- **ナレッジベース**: コレクションとドキュメントを所有する最上位コンテナ。属性には名前、説明、所有者、作成日が含まれる。各ナレッジベースには必ず1つのデフォルトコレクションが存在する
- **コレクション**: ナレッジベース内の組織単位。フラット構造(ネストなし)。属性には名前、説明、ナレッジベース参照、ドキュメント数、作成日、is_default(デフォルトコレクションフラグ)が含まれる
- **ドキュメント**: アップロードされたファイルを表す既存エンティティ。1つのコレクションにのみ所属。コレクション参照(外部キー)を含む。既存の属性(ファイル名、ファイルタイプ、OCRデータ、階層要素、アップロード日)を維持

### サービス統合

**対象サービス**:

- **ai-micro-api-admin**: コレクション管理API(コレクションの作成、読み取り、更新、削除)を実装する主要サービス
- **ai-micro-front-admin**: コレクションUIとドキュメント整理インターフェースのフロントエンドサービス
- **admindb**: コレクションメタデータとドキュメント-コレクション関連性を格納するデータベース

**サービス間依存関係**:

- **認証**: ai-micro-api-authサービスからの既存JWT認証を使用
- **データアクセス**: admindbデータベースに新しい`collections`テーブルが必要。既存の`documents`テーブルにコレクション参照(外部キー)を追加するための変更が必要
- **API呼び出し**: フロントエンドがAdmin APIエンドポイントをコレクション操作のために呼び出す
- **共有状態**: コレクションメタデータとドキュメント数のキャッシュにRedisを使用する可能性

**統合ポイント**:

- 新しいコレクション管理エンドポイントを公開(例: POST/GET/PUT/DELETE /api/collections)
- 既存のドキュメントアップロード/管理エンドポイントを変更してコレクション割り当てを受け入れる
- ユーザー検証のために既存の認証エンドポイントを使用
- 既存のドキュメントOCRおよび処理ワークフローとの互換性を維持
- 検索エンドポイントにコレクション絞り込みパラメータを追加

**後方互換性**:

- 既存のドキュメントは自動的にデフォルトコレクションに割り当てられる
- 既存のドキュメントAPIは引き続き機能しなければならない
- ドキュメントIDと参照は安定したままでなければならない
- OCRおよび階層要素データは保持されなければならない
- ドキュメント閲覧のフロントエンドルートは、移行期間中、レガシー(フラット)と新規(階層)の両構造をサポートしなければならない

---

## レビュー & 受け入れチェックリスト

### コンテンツ品質

- [x] 実装詳細なし(言語、フレームワーク、API)
- [x] ユーザー価値とビジネスニーズに焦点
- [x] 非技術的な関係者向けに記述
- [x] すべての必須セクション完了

### 要件の完全性

- [x] [要明確化]マーカーが残っていない - **主要な5つの明確化ポイントが解決されました**
- [x] 要件はテスト可能で明確
- [x] 成功基準は測定可能
- [x] スコープが明確に定義されている
- [x] 依存関係と仮定が特定されている

---

## 実行ステータス

- [x] ユーザー説明の解析完了
- [x] 主要概念の抽出完了
- [x] 曖昧性のマーク完了
- [x] ユーザーシナリオ定義完了
- [x] 要件生成完了
- [x] エンティティ特定完了
- [x] レビューチェックリスト合格

---
