# èªè¨¼ã‚µãƒ¼ãƒ“ã‚¹æ¦‚è¦

**ä½œæˆæ—¥**: 2025-09-30
**æœ€çµ‚æ›´æ–°**: 2025-09-30
**å¯¾è±¡ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: v1.0

## ğŸ“‹ ç›®æ¬¡

- [æ¦‚è¦](#æ¦‚è¦)
- [ã‚µãƒ¼ãƒ“ã‚¹ã®è²¬å‹™](#ã‚µãƒ¼ãƒ“ã‚¹ã®è²¬å‹™)
- [æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯](#æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯)
- [ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£](#ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£)
- [ä¸»è¦æ©Ÿèƒ½](#ä¸»è¦æ©Ÿèƒ½)
- [é€šä¿¡ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹](#é€šä¿¡ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹)
- [ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è€ƒæ…®äº‹é …](#ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è€ƒæ…®äº‹é …)
- [ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç‰¹æ€§](#ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç‰¹æ€§)

---

## æ¦‚è¦

èªè¨¼ã‚µãƒ¼ãƒ“ã‚¹ï¼ˆai-micro-api-authï¼‰ã¯ã€ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ã®èªè¨¼ãƒ»èªå¯åŸºç›¤ã‚’æä¾›ã™ã‚‹ãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹ã§ã™ã€‚JWTï¼ˆJSON Web Tokenï¼‰ã‚’ä½¿ç”¨ã—ãŸå …ç‰¢ãªèªè¨¼æ©Ÿèƒ½ã‚’å®Ÿè£…ã—ã€å…¨ã¦ã®ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚µãƒ¼ãƒ“ã‚¹ãŠã‚ˆã³ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚µãƒ¼ãƒ“ã‚¹ã«å¯¾ã—ã¦çµ±ä¸€ã•ã‚ŒãŸèªè¨¼æ©Ÿèƒ½ã‚’æä¾›ã—ã¾ã™ã€‚

### ã‚µãƒ¼ãƒ“ã‚¹ã®ç‰¹å¾´

- **FastAPIãƒ™ãƒ¼ã‚¹**: é«˜é€Ÿã§å‹å®‰å…¨ãªAPIå®Ÿè£…
- **RS256ç½²å**: RSAå…¬é–‹éµæš—å·æ–¹å¼ã«ã‚ˆã‚‹JWTç½²å
- **JWKSå¯¾å¿œ**: JSON Web Key SetçµŒç”±ã®å…¬é–‹éµé…å¸ƒ
- **Redisçµ±åˆ**: ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ã¨ãƒˆãƒ¼ã‚¯ãƒ³ãƒ–ãƒ©ãƒƒã‚¯ãƒªã‚¹ãƒˆ
- **PostgreSQL**: ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼æƒ…å ±ã®æ°¸ç¶šåŒ–

### ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆæƒ…å ±

```
ã‚µãƒ¼ãƒ“ã‚¹å: ai-micro-api-auth
ãƒãƒ¼ãƒˆç•ªå·: 8002
ãƒ—ãƒ­ãƒˆã‚³ãƒ«: HTTP/REST
ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹: authdb (PostgreSQL)
ã‚­ãƒ£ãƒƒã‚·ãƒ¥: Redis
```

---

## ã‚µãƒ¼ãƒ“ã‚¹ã®è²¬å‹™

### ä¸»è¦è²¬å‹™

1. **ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼**
   - ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†ï¼ˆãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹/ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼‰
   - ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²
   - ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒãƒƒã‚·ãƒ¥åŒ–ï¼ˆbcrypt/argon2ï¼‰
   - èªè¨¼å¤±æ•—ã®è¨˜éŒ²ã¨ãƒ¬ãƒ¼ãƒˆåˆ¶é™

2. **ãƒˆãƒ¼ã‚¯ãƒ³ç®¡ç†**
   - ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ç™ºè¡Œï¼ˆæœ‰åŠ¹æœŸé™: 15åˆ†ï¼‰
   - ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ç™ºè¡Œï¼ˆæœ‰åŠ¹æœŸé™: 7æ—¥ï¼‰
   - ãƒˆãƒ¼ã‚¯ãƒ³ã®ãƒ–ãƒ©ãƒƒã‚¯ãƒªã‚¹ãƒˆç®¡ç†
   - ãƒˆãƒ¼ã‚¯ãƒ³æ›´æ–°ï¼ˆãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ï¼‰å‡¦ç†

3. **å…¬é–‹éµé…å¸ƒ**
   - JWKSï¼ˆJSON Web Key Setï¼‰ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®æä¾›
   - å…¬é–‹éµã®ã‚­ãƒ£ãƒƒã‚·ãƒ³ã‚°
   - ã‚­ãƒ¼ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³å¯¾å¿œ

4. **ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†**
   - Redisãƒ™ãƒ¼ã‚¹ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¹ãƒˆã‚¢
   - ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®æœ‰åŠ¹æœŸé™ç®¡ç†
   - ãƒ­ã‚°ã‚¢ã‚¦ãƒˆæ™‚ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ç ´æ£„

5. **ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ç®¡ç†**
   - ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆ
   - ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´
   - ãƒ­ãƒ¼ãƒ«ï¼ˆroleï¼‰æƒ…å ±ã®ç®¡ç†

### éè²¬å‹™

ä»¥ä¸‹ã¯ã“ã®ã‚µãƒ¼ãƒ“ã‚¹ã®è²¬å‹™**å¤–**ã§ã™ï¼š

- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«è©³ç´°æƒ…å ±ã®ç®¡ç†ï¼ˆUser APIã®è²¬å‹™ï¼‰
- ç®¡ç†è€…å°‚ç”¨æ©Ÿèƒ½ï¼ˆAdmin APIã®è²¬å‹™ï¼‰
- UIãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ï¼ˆFrontend BFFã®è²¬å‹™ï¼‰
- ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå‡¦ç†ï¼ˆAdmin APIã®è²¬å‹™ï¼‰

---

## æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯

### ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ãƒ»ãƒ©ã‚¤ãƒ–ãƒ©ãƒª

```python
# ä¸»è¦æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯
FastAPI==0.109.x        # Webãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯
Pydantic==2.x          # ãƒ‡ãƒ¼ã‚¿ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
SQLAlchemy==2.0.x      # ORM
Alembic                # DBãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
python-jose[cryptography]  # JWTå‡¦ç†
passlib[bcrypt]        # ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒãƒƒã‚·ãƒ¥åŒ–
redis==5.x             # Redisçµ±åˆ
asyncpg                # PostgreSQLéåŒæœŸãƒ‰ãƒ©ã‚¤ãƒ
```

### é–‹ç™ºãƒ„ãƒ¼ãƒ«

```python
# é–‹ç™ºãƒ»å“è³ªç®¡ç†
Poetry                 # ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ç®¡ç†
Ruff                   # ãƒªãƒ³ã‚¿ãƒ¼
Black                  # ãƒ•ã‚©ãƒ¼ãƒãƒƒã‚¿ãƒ¼
MyPy                   # å‹ãƒã‚§ãƒƒã‚¯
Pytest                 # ãƒ†ã‚¹ãƒˆãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯
```

### ã‚¤ãƒ³ãƒ•ãƒ©ã‚¹ãƒˆãƒ©ã‚¯ãƒãƒ£

- **ã‚³ãƒ³ãƒ†ãƒŠ**: Docker + docker-compose
- **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹**: PostgreSQL 15+
- **ã‚­ãƒ£ãƒƒã‚·ãƒ¥**: Redis 7+
- **ãƒªãƒãƒ¼ã‚¹ãƒ—ãƒ­ã‚­ã‚·**: Nginxï¼ˆæœ¬ç•ªç’°å¢ƒï¼‰

---

## ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

### ãƒ¬ã‚¤ãƒ¤ãƒ¼æ§‹é€ 

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         API Layer (FastAPI)             â”‚
â”‚  - ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°                          â”‚
â”‚  - ãƒªã‚¯ã‚¨ã‚¹ãƒˆ/ãƒ¬ã‚¹ãƒãƒ³ã‚¹å‡¦ç†             â”‚
â”‚  - ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Service Layer                   â”‚
â”‚  - ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯                      â”‚
â”‚  - JWTç”Ÿæˆãƒ»æ¤œè¨¼                         â”‚
â”‚  - ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å‡¦ç†                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Repository Layer                â”‚
â”‚  - ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹æŠ½è±¡åŒ–                  â”‚
â”‚  - SQLAlchemyçµ±åˆ                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚                â”‚
â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
â”‚ PostgreSQL â”‚  â”‚   Redis    â”‚
â”‚  (authdb)  â”‚  â”‚ (session)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ 

```
ai-micro-api-auth/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ main.py                 # ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆ
â”‚   â”œâ”€â”€ core/
â”‚   â”‚   â”œâ”€â”€ config.py          # è¨­å®šç®¡ç†
â”‚   â”‚   â”œâ”€â”€ security.py        # JWTãƒ»ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ©Ÿèƒ½
â”‚   â”‚   â””â”€â”€ dependencies.py    # DIï¼ˆä¾å­˜æ€§æ³¨å…¥ï¼‰
â”‚   â”œâ”€â”€ api/
â”‚   â”‚   â””â”€â”€ v1/
â”‚   â”‚       â”œâ”€â”€ endpoints/
â”‚   â”‚       â”‚   â”œâ”€â”€ auth.py    # èªè¨¼ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
â”‚   â”‚       â”‚   â””â”€â”€ jwks.py    # JWKSã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
â”‚   â”‚       â””â”€â”€ router.py      # APIãƒ«ãƒ¼ã‚¿ãƒ¼
â”‚   â”œâ”€â”€ models/
â”‚   â”‚   â””â”€â”€ user.py            # SQLAlchemyãƒ¢ãƒ‡ãƒ«
â”‚   â”œâ”€â”€ schemas/
â”‚   â”‚   â”œâ”€â”€ auth.py            # èªè¨¼ã‚¹ã‚­ãƒ¼ãƒ
â”‚   â”‚   â””â”€â”€ token.py           # ãƒˆãƒ¼ã‚¯ãƒ³ã‚¹ã‚­ãƒ¼ãƒ
â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”œâ”€â”€ auth_service.py    # èªè¨¼ãƒ­ã‚¸ãƒƒã‚¯
â”‚   â”‚   â””â”€â”€ token_service.py   # ãƒˆãƒ¼ã‚¯ãƒ³ç®¡ç†
â”‚   â””â”€â”€ repositories/
â”‚       â””â”€â”€ user_repository.py # ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹
â”œâ”€â”€ keys/
â”‚   â”œâ”€â”€ private_key.pem        # RSAç§˜å¯†éµ
â”‚   â””â”€â”€ public_key.pem         # RSAå…¬é–‹éµ
â”œâ”€â”€ alembic/                   # DBãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
â”œâ”€â”€ tests/                     # ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰
â”œâ”€â”€ Dockerfile
â”œâ”€â”€ docker-compose.yml
â””â”€â”€ pyproject.toml            # Poetryè¨­å®š
```

---

## ä¸»è¦æ©Ÿèƒ½

### 1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²

æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ä½œæˆã‚’è¡Œã„ã¾ã™ã€‚

**ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**: `POST /api/v1/auth/register`

**å‡¦ç†ãƒ•ãƒ­ãƒ¼**:
```
1. ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆãƒ¡ãƒ¼ãƒ«å½¢å¼ã€ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¼·åº¦ï¼‰
2. ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®é‡è¤‡ãƒã‚§ãƒƒã‚¯
3. ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®ãƒãƒƒã‚·ãƒ¥åŒ–ï¼ˆbcryptï¼‰
4. authdb.usersãƒ†ãƒ¼ãƒ–ãƒ«ã¸ã®ä¿å­˜
5. ãƒ¦ãƒ¼ã‚¶ãƒ¼IDï¼ˆUUIDï¼‰ã®è¿”å´
```

### 2. ãƒ­ã‚°ã‚¤ãƒ³

èªè¨¼æƒ…å ±ã‚’æ¤œè¨¼ã—ã€JWTãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç™ºè¡Œã—ã¾ã™ã€‚

**ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**: `POST /api/v1/auth/login`

**å‡¦ç†ãƒ•ãƒ­ãƒ¼**:
```
1. ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¤œç´¢
2. ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒãƒƒã‚·ãƒ¥ã®æ¤œè¨¼
3. ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ç”Ÿæˆï¼ˆ15åˆ†æœ‰åŠ¹ï¼‰
4. ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ç”Ÿæˆï¼ˆ7æ—¥æœ‰åŠ¹ï¼‰
5. Redisã«ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ä¿å­˜
6. ãƒˆãƒ¼ã‚¯ãƒ³ãƒšã‚¢ã‚’è¿”å´
```

### 3. ãƒˆãƒ¼ã‚¯ãƒ³ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥

æœ‰åŠ¹ãªãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ã§æ–°ã—ã„ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—ã—ã¾ã™ã€‚

**ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**: `POST /api/v1/auth/refresh`

**å‡¦ç†ãƒ•ãƒ­ãƒ¼**:
```
1. ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ã®æ¤œè¨¼
2. ãƒ–ãƒ©ãƒƒã‚¯ãƒªã‚¹ãƒˆãƒã‚§ãƒƒã‚¯
3. æ–°ã—ã„ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ç”Ÿæˆ
4. æ–°ã—ã„ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ç”Ÿæˆï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
5. å¤ã„ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ãƒ–ãƒ©ãƒƒã‚¯ãƒªã‚¹ãƒˆç™»éŒ²
6. æ–°ãƒˆãƒ¼ã‚¯ãƒ³ãƒšã‚¢ã‚’è¿”å´
```

### 4. ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ

ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç„¡åŠ¹åŒ–ã—ã€ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ç ´æ£„ã—ã¾ã™ã€‚

**ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**: `POST /api/v1/auth/logout`

**å‡¦ç†ãƒ•ãƒ­ãƒ¼**:
```
1. ãƒˆãƒ¼ã‚¯ãƒ³ã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼IDæŠ½å‡º
2. ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ãƒ–ãƒ©ãƒƒã‚¯ãƒªã‚¹ãƒˆç™»éŒ²ï¼ˆRedisï¼‰
3. ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±å‰Šé™¤ï¼ˆRedisï¼‰
4. æˆåŠŸãƒ¬ã‚¹ãƒãƒ³ã‚¹è¿”å´
```

### 5. JWKSå…¬é–‹

JWTæ¤œè¨¼ç”¨ã®å…¬é–‹éµã‚’JSON Web Key Setå½¢å¼ã§æä¾›ã—ã¾ã™ã€‚

**ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**: `GET /.well-known/jwks.json`

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹ä¾‹**:
```json
{
  "keys": [
    {
      "kty": "RSA",
      "use": "sig",
      "kid": "auth-service-key-1",
      "alg": "RS256",
      "n": "...",
      "e": "AQAB"
    }
  ]
}
```

---

## é€šä¿¡ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹

### å—ä¿¡æ¥ç¶šï¼ˆInboundï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ User Frontend   â”‚â”€â”€â”
â”‚ (Port: 3002)    â”‚  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
                     â”œâ”€â”€â†’ POST /api/v1/auth/login
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    POST /api/v1/auth/register
â”‚ Admin Frontend  â”‚â”€â”€â”˜    POST /api/v1/auth/refresh
â”‚ (Port: 3003)    â”‚       POST /api/v1/auth/logout
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       GET  /.well-known/jwks.json
```

### é€ä¿¡æ¥ç¶šï¼ˆOutboundï¼‰

```
Auth Service (Port: 8002)
     â”‚
     â”œâ”€â”€â†’ PostgreSQL (Port: 5432/authdb)
     â”‚    - ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã®èª­ã¿æ›¸ã
     â”‚
     â””â”€â”€â†’ Redis (Port: 6379)
          - ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†
          - ãƒˆãƒ¼ã‚¯ãƒ³ãƒ–ãƒ©ãƒƒã‚¯ãƒªã‚¹ãƒˆ
          - ã‚­ãƒ£ãƒƒã‚·ãƒ³ã‚°
```

### ä»–ã‚µãƒ¼ãƒ“ã‚¹ã‹ã‚‰ã®JWTæ¤œè¨¼

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ User API        â”‚â”€â”€â”
â”‚ (Port: 8001)    â”‚  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
                     â”œâ”€â”€â†’ GET /.well-known/jwks.json
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    (JWTæ¤œè¨¼ç”¨å…¬é–‹éµå–å¾—)
â”‚ Admin API       â”‚â”€â”€â”˜
â”‚ (Port: 8003)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è€ƒæ…®äº‹é …

### å®Ÿè£…æ¸ˆã¿ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ©Ÿèƒ½

1. **ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£**
   - bcryptãƒãƒƒã‚·ãƒ¥ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ä½¿ç”¨
   - ã‚½ãƒ«ãƒˆè‡ªå‹•ç”Ÿæˆ
   - æœ€å°ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰é•·: 8æ–‡å­—
   - ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰è¤‡é›‘æ€§è¦ä»¶

2. **ãƒˆãƒ¼ã‚¯ãƒ³ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£**
   - RS256ç½²åã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ï¼ˆéå¯¾ç§°éµï¼‰
   - çŸ­æ™‚é–“ã®ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³æœ‰åŠ¹æœŸé™ï¼ˆ15åˆ†ï¼‰
   - ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³
   - ãƒˆãƒ¼ã‚¯ãƒ³ãƒ–ãƒ©ãƒƒã‚¯ãƒªã‚¹ãƒˆæ©Ÿèƒ½

3. **é€šä¿¡ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£**
   - CORSè¨­å®š
   - ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ˜ãƒƒãƒ€ãƒ¼è¨­å®š
   - ãƒ¬ãƒ¼ãƒˆåˆ¶é™ï¼ˆè¨ˆç”»ä¸­ï¼‰

4. **ãƒ‡ãƒ¼ã‚¿ä¿è­·**
   - ç’°å¢ƒå¤‰æ•°ã«ã‚ˆã‚‹æ©Ÿå¯†æƒ…å ±ç®¡ç†
   - ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šã®æš—å·åŒ–
   - Redisæ¥ç¶šã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ä¿è­·

### ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹

```python
# ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒãƒƒã‚·ãƒ¥åŒ–ä¾‹
from passlib.context import CryptContext

pwd_context = CryptContext(schemes=["bcrypt"], deprecated="auto")

def hash_password(password: str) -> str:
    return pwd_context.hash(password)

def verify_password(plain_password: str, hashed_password: str) -> bool:
    return pwd_context.verify(plain_password, hashed_password)
```

---

## ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç‰¹æ€§

### ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚¿ã‚¤ãƒ ç›®æ¨™

| ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ | ç›®æ¨™ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚¿ã‚¤ãƒ  | èª¬æ˜ |
|--------------|-------------------|------|
| POST /login | < 200ms | ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰æ¤œè¨¼å«ã‚€ |
| POST /register | < 300ms | DBæ›¸ãè¾¼ã¿å«ã‚€ |
| POST /refresh | < 100ms | ãƒˆãƒ¼ã‚¯ãƒ³ç”Ÿæˆã®ã¿ |
| POST /logout | < 50ms | Redisæ“ä½œã®ã¿ |
| GET /jwks.json | < 50ms | ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰è¿”å´ |

### ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£

- **æ°´å¹³ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°**: å¯èƒ½ï¼ˆã‚¹ãƒ†ãƒ¼ãƒˆãƒ¬ã‚¹è¨­è¨ˆï¼‰
- **ã‚»ãƒƒã‚·ãƒ§ãƒ³å…±æœ‰**: RedisçµŒç”±ã§è¤‡æ•°ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹é–“ã§å…±æœ‰
- **å…¬é–‹éµã‚­ãƒ£ãƒƒã‚·ãƒ¥**: ãƒ¡ãƒ¢ãƒªã‚­ãƒ£ãƒƒã‚·ãƒ¥ã¨Redisã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®äºŒæ®µæ§‹æˆ

### ãƒœãƒˆãƒ«ãƒãƒƒã‚¯

- **PostgreSQLæ¥ç¶š**: ã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³ãƒ—ãƒ¼ãƒ«è¨­å®šãŒé‡è¦
- **Redisæ¥ç¶š**: é«˜è² è·æ™‚ã®Rediså¿œç­”æ™‚é–“
- **ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒãƒƒã‚·ãƒ¥**: bcryptã®ã‚³ã‚¹ãƒˆä¿‚æ•°èª¿æ•´ãŒå¿…è¦

---

## é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- [èªè¨¼APIä»•æ§˜](./02-api-specification.md)
- [JWTè¨­è¨ˆ](./03-jwt-design.md)
- [authdbãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ](./04-database-design.md)
- [ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å®Ÿè£…](./05-security-implementation.md)
- [ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£](../00-overview/01-system-architecture.md)
- [ã‚µãƒ¼ãƒ“ã‚¹é–“é€šä¿¡](../08-integration/01-service-communication.md)