# JWTè¨­è¨ˆ

**ä½œæˆæ—¥**: 2025-09-30
**æœ€çµ‚æ›´æ–°**: 2025-09-30
**å¯¾è±¡ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: v1.0

## ğŸ“‹ ç›®æ¬¡

- [æ¦‚è¦](#æ¦‚è¦)
- [JWTæ§‹é€ ](#jwtæ§‹é€ )
- [ç½²åã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ](#ç½²åã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ )
- [ãƒˆãƒ¼ã‚¯ãƒ³ã‚¿ã‚¤ãƒ—](#ãƒˆãƒ¼ã‚¯ãƒ³ã‚¿ã‚¤ãƒ—)
- [ã‚¯ãƒ¬ãƒ¼ãƒ è¨­è¨ˆ](#ã‚¯ãƒ¬ãƒ¼ãƒ è¨­è¨ˆ)
- [ãƒˆãƒ¼ã‚¯ãƒ³ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«](#ãƒˆãƒ¼ã‚¯ãƒ³ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«)
- [ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è€ƒæ…®äº‹é …](#ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è€ƒæ…®äº‹é …)
- [å®Ÿè£…ä¾‹](#å®Ÿè£…ä¾‹)

---

## æ¦‚è¦

æœ¬ã‚·ã‚¹ãƒ†ãƒ ã§ã¯ã€JWTï¼ˆJSON Web Tokenï¼‰ã‚’ä½¿ç”¨ã—ãŸèªè¨¼ãƒ»èªå¯æ©Ÿèƒ½ã‚’å®Ÿè£…ã—ã¦ã„ã¾ã™ã€‚RS256ï¼ˆRSAç½²åï¼‰ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã‚’æ¡ç”¨ã—ã€JWKSï¼ˆJSON Web Key Setï¼‰çµŒç”±ã§å…¬é–‹éµã‚’é…å¸ƒã™ã‚‹ã“ã¨ã§ã€å„ã‚µãƒ¼ãƒ“ã‚¹ãŒç‹¬ç«‹ã—ã¦ãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼ã‚’è¡Œãˆã‚‹è¨­è¨ˆã¨ãªã£ã¦ã„ã¾ã™ã€‚

### JWTæ¡ç”¨ç†ç”±

1. **ã‚¹ãƒ†ãƒ¼ãƒˆãƒ¬ã‚¹èªè¨¼**
   - ã‚µãƒ¼ãƒãƒ¼å´ã§ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ã‚’ä¿æŒä¸è¦
   - æ°´å¹³ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°ãŒå®¹æ˜“

2. **ã‚µãƒ¼ãƒ“ã‚¹é–“é€šä¿¡ã®ç°¡ç´ åŒ–**
   - å„ã‚µãƒ¼ãƒ“ã‚¹ãŒç‹¬ç«‹ã—ã¦ãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼å¯èƒ½
   - èªè¨¼ã‚µãƒ¼ãƒ“ã‚¹ã¸ã®å•ã„åˆã‚ã›ä¸è¦

3. **æ¨™æº–åŒ–ã•ã‚ŒãŸä»•æ§˜**
   - RFC 7519ã«æº–æ‹ 
   - å¤šè¨€èªãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ã‚µãƒãƒ¼ãƒˆ

4. **è±Šå¯Œãªæƒ…å ±æ ¼ç´**
   - ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã€ãƒ­ãƒ¼ãƒ«ã€æ¨©é™ãªã©ã‚’å«ã‚ã‚‰ã‚Œã‚‹
   - ã‚µãƒ¼ãƒ“ã‚¹é–“ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å…±æœ‰

---

## JWTæ§‹é€ 

JWTã¯3ã¤ã®éƒ¨åˆ†ã‹ã‚‰æ§‹æˆã•ã‚Œã¾ã™ï¼š

```
eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCIsImtpZCI6ImF1dGgtc2VydmljZS1rZXktMSJ9.
eyJzdWIiOiI1NTBlODQwMC1lMjliLTQxZDQtYTcxNi00NDY2NTU0NDAwMDAiLCJlbWFpbCI6InVzZXJAZXhhbXBsZS5jb20iLCJyb2xlIjoidXNlciIsImlzcyI6Imh0dHBzOi8vYXV0aC5leGFtcGxlLmNvbSIsImF1ZCI6ImZhc3RhcGktYXBpIiwiaWF0IjoxNzI3NjkzNDAwLCJleHAiOjE3Mjc2OTQzMDB9.
[ç½²åéƒ¨åˆ†]
```

### 1. ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆHeaderï¼‰

```json
{
  "alg": "RS256",
  "typ": "JWT",
  "kid": "auth-service-key-1"
}
```

**ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰èª¬æ˜**:
- `alg`: ç½²åã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ï¼ˆRS256å›ºå®šï¼‰
- `typ`: ãƒˆãƒ¼ã‚¯ãƒ³ã‚¿ã‚¤ãƒ—ï¼ˆJWTå›ºå®šï¼‰
- `kid`: ã‚­ãƒ¼IDï¼ˆJWKSå†…ã®å…¬é–‹éµã‚’ç‰¹å®šï¼‰

### 2. ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ï¼ˆPayloadï¼‰

```json
{
  "sub": "550e8400-e29b-41d4-a716-446655440000",
  "email": "user@example.com",
  "role": "user",
  "iss": "https://auth.example.com",
  "aud": "fastapi-api",
  "iat": 1727693400,
  "exp": 1727694300,
  "jti": "abc123def456"
}
```

### 3. ç½²åï¼ˆSignatureï¼‰

RSAç§˜å¯†éµã‚’ä½¿ç”¨ã—ã¦ãƒ˜ãƒƒãƒ€ãƒ¼ã¨ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã«ç½²åã—ã¾ã™ï¼š

```
RSASSA-PKCS1-v1_5(
  base64UrlEncode(header) + "." + base64UrlEncode(payload),
  privateKey
)
```

---

## ç½²åã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ 

### RS256ï¼ˆRSA Signature with SHA-256ï¼‰

æœ¬ã‚·ã‚¹ãƒ†ãƒ ã§ã¯RS256ã‚’æ¡ç”¨ã—ã¦ã„ã¾ã™ã€‚

#### RS256ã®ç‰¹å¾´

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          Auth Service                   â”‚
â”‚                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚
â”‚  â”‚ ç§˜å¯†éµ       â”‚ â”€â”€â”€â”€â†’ JWTç½²å        â”‚
â”‚  â”‚ private_key  â”‚                      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
â”‚                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚
â”‚  â”‚ å…¬é–‹éµ       â”‚ â”€â”€â”€â”€â†’ JWKSé…å¸ƒ       â”‚
â”‚  â”‚ public_key   â”‚                      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â”‚ JWT + JWKS
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      User API / Admin API               â”‚
â”‚                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚
â”‚  â”‚ å…¬é–‹éµå–å¾—   â”‚ â†â”€â”€â”€â”€ JWKSèª­è¾¼       â”‚
â”‚  â”‚ (JWKS)       â”‚                      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
â”‚           â”‚                             â”‚
â”‚           â–¼                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚
â”‚  â”‚ JWTæ¤œè¨¼      â”‚                      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### æ¡ç”¨ç†ç”±

1. **éå¯¾ç§°éµæš—å·**
   - ç§˜å¯†éµã¯èªè¨¼ã‚µãƒ¼ãƒ“ã‚¹ã®ã¿ãŒä¿æŒ
   - å…¬é–‹éµã¯å…¨ã‚µãƒ¼ãƒ“ã‚¹ã§å…±æœ‰å¯èƒ½
   - ç§˜å¯†éµæµå‡ºãƒªã‚¹ã‚¯ã®å±€æ‰€åŒ–

2. **ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£**
   - å„ã‚µãƒ¼ãƒ“ã‚¹ãŒç‹¬ç«‹ã—ã¦ãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼
   - èªè¨¼ã‚µãƒ¼ãƒ“ã‚¹ã¸ã®æ¤œè¨¼ãƒªã‚¯ã‚¨ã‚¹ãƒˆä¸è¦

3. **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£**
   - HS256ï¼ˆå…±æœ‰éµï¼‰ã‚ˆã‚Šå®‰å…¨
   - å…¬é–‹éµãŒæµå‡ºã—ã¦ã‚‚æ”¹ã–ã‚“ä¸å¯

#### RSAã‚­ãƒ¼ãƒšã‚¢ç”Ÿæˆ

```bash
# ç§˜å¯†éµç”Ÿæˆï¼ˆ2048ãƒ“ãƒƒãƒˆï¼‰
openssl genrsa -out private_key.pem 2048

# å…¬é–‹éµæŠ½å‡º
openssl rsa -in private_key.pem -pubout -out public_key.pem

# ã‚­ãƒ¼æ¤œè¨¼
openssl rsa -in private_key.pem -check
```

---

## ãƒˆãƒ¼ã‚¯ãƒ³ã‚¿ã‚¤ãƒ—

### 1. ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ï¼ˆAccess Tokenï¼‰

çŸ­æ™‚é–“æœ‰åŠ¹ãªãƒˆãƒ¼ã‚¯ãƒ³ã§ã€APIãƒªã‚¯ã‚¨ã‚¹ãƒˆã«ä½¿ç”¨ã—ã¾ã™ã€‚

**æœ‰åŠ¹æœŸé™**: 15åˆ†

**ç”¨é€”**:
- APIèªè¨¼
- ãƒªã‚½ãƒ¼ã‚¹ã‚¢ã‚¯ã‚»ã‚¹
- ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã®å–å¾—

**ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ä¾‹**:
```json
{
  "sub": "550e8400-e29b-41d4-a716-446655440000",
  "email": "user@example.com",
  "role": "user",
  "iss": "https://auth.example.com",
  "aud": "fastapi-api",
  "iat": 1727693400,
  "exp": 1727694300,
  "token_type": "access"
}
```

### 2. ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ï¼ˆRefresh Tokenï¼‰

é•·æ™‚é–“æœ‰åŠ¹ãªãƒˆãƒ¼ã‚¯ãƒ³ã§ã€ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã®æ›´æ–°ã«ä½¿ç”¨ã—ã¾ã™ã€‚

**æœ‰åŠ¹æœŸé™**: 7æ—¥

**ç”¨é€”**:
- ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã®å†ç™ºè¡Œ
- ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã®ç¶­æŒ

**ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ä¾‹**:
```json
{
  "sub": "550e8400-e29b-41d4-a716-446655440000",
  "iss": "https://auth.example.com",
  "aud": "fastapi-api",
  "iat": 1727693400,
  "exp": 1728298200,
  "token_type": "refresh",
  "jti": "unique-token-id-123"
}
```

**ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾ç­–**:
- ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ã¯æœ€å°é™ã®æƒ…å ±ã®ã¿å«ã‚€
- JTIï¼ˆJWT IDï¼‰ã§ãƒˆãƒ¼ã‚¯ãƒ³è¿½è·¡
- ä½¿ç”¨å¾Œã¯æ–°ãƒˆãƒ¼ã‚¯ãƒ³ç™ºè¡Œï¼‹æ—§ãƒˆãƒ¼ã‚¯ãƒ³ç„¡åŠ¹åŒ–

---

## ã‚¯ãƒ¬ãƒ¼ãƒ è¨­è¨ˆ

### æ¨™æº–ã‚¯ãƒ¬ãƒ¼ãƒ ï¼ˆRFC 7519ï¼‰

| ã‚¯ãƒ¬ãƒ¼ãƒ  | å‹ | å¿…é ˆ | èª¬æ˜ | ä¾‹ |
|---------|-----|------|------|-----|
| `iss` | string | Yes | ç™ºè¡Œè€…ï¼ˆIssuerï¼‰ | "https://auth.example.com" |
| `sub` | string | Yes | ä¸»ä½“ï¼ˆSubjectï¼‰ | "550e8400-e29b-41d4-..." |
| `aud` | string | Yes | å¯¾è±¡è€…ï¼ˆAudienceï¼‰ | "fastapi-api" |
| `exp` | number | Yes | æœ‰åŠ¹æœŸé™ï¼ˆExpiration Timeï¼‰ | 1727694300 |
| `iat` | number | Yes | ç™ºè¡Œæ™‚åˆ»ï¼ˆIssued Atï¼‰ | 1727693400 |
| `jti` | string | No | JWT IDï¼ˆä¸€æ„è­˜åˆ¥å­ï¼‰ | "abc123def456" |

### ã‚«ã‚¹ã‚¿ãƒ ã‚¯ãƒ¬ãƒ¼ãƒ 

| ã‚¯ãƒ¬ãƒ¼ãƒ  | å‹ | å¿…é ˆ | èª¬æ˜ | ä¾‹ |
|---------|-----|------|------|-----|
| `email` | string | Yes | ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ | "user@example.com" |
| `role` | string | Yes | ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ­ãƒ¼ãƒ« | "user", "admin" |
| `token_type` | string | Yes | ãƒˆãƒ¼ã‚¯ãƒ³ã‚¿ã‚¤ãƒ— | "access", "refresh" |
| `permissions` | array | No | æ¨©é™ãƒªã‚¹ãƒˆ | ["read:profile", "write:profile"] |

### ã‚¯ãƒ¬ãƒ¼ãƒ æ¤œè¨¼ãƒ«ãƒ¼ãƒ«

```python
# æ¤œè¨¼é …ç›®
1. expï¼ˆæœ‰åŠ¹æœŸé™ï¼‰: ç¾åœ¨æ™‚åˆ»ã‚ˆã‚Šæœªæ¥ã§ã‚ã‚‹ã“ã¨
2. iatï¼ˆç™ºè¡Œæ™‚åˆ»ï¼‰: ç¾åœ¨æ™‚åˆ»ã‚ˆã‚Šéå»ã§ã‚ã‚‹ã“ã¨
3. issï¼ˆç™ºè¡Œè€…ï¼‰: ä¿¡é ¼ã§ãã‚‹ç™ºè¡Œè€…ã§ã‚ã‚‹ã“ã¨
4. audï¼ˆå¯¾è±¡è€…ï¼‰: è‡ªã‚µãƒ¼ãƒ“ã‚¹ãŒå¯¾è±¡ã«å«ã¾ã‚Œã‚‹ã“ã¨
5. subï¼ˆä¸»ä½“ï¼‰: UUIDå½¢å¼ã§ã‚ã‚‹ã“ã¨
6. ç½²å: å…¬é–‹éµã§æ¤œè¨¼æˆåŠŸã™ã‚‹ã“ã¨
```

---

## ãƒˆãƒ¼ã‚¯ãƒ³ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«

### 1. ãƒˆãƒ¼ã‚¯ãƒ³ç™ºè¡Œãƒ•ãƒ­ãƒ¼

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ãƒ¦ãƒ¼ã‚¶ãƒ¼  â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
      â”‚ 1. ãƒ­ã‚°ã‚¤ãƒ³
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Auth Service                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ 1. èªè¨¼æƒ…å ±æ¤œè¨¼                  â”‚ â”‚
â”‚  â”‚ 2. ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±å–å¾—              â”‚ â”‚
â”‚  â”‚ 3. ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰æ§‹ç¯‰                â”‚ â”‚
â”‚  â”‚ 4. RSAç§˜å¯†éµã§ç½²å               â”‚ â”‚
â”‚  â”‚ 5. ã‚¢ã‚¯ã‚»ã‚¹+ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ç”Ÿæˆ     â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚ 2. ãƒˆãƒ¼ã‚¯ãƒ³ãƒšã‚¢è¿”å´
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ãƒ¦ãƒ¼ã‚¶ãƒ¼  â”‚ â”€â”€â†’ ãƒˆãƒ¼ã‚¯ãƒ³ä¿å­˜ï¼ˆCookie/LocalStorageï¼‰
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. ãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼ãƒ•ãƒ­ãƒ¼

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ãƒ¦ãƒ¼ã‚¶ãƒ¼  â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
      â”‚ 1. APIå‘¼ã³å‡ºã—ï¼ˆAuthorization: Bearer {token}ï¼‰
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  User API / Admin API                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ 1. Authorizationãƒ˜ãƒƒãƒ€ãƒ¼æŠ½å‡º     â”‚ â”‚
â”‚  â”‚ 2. JWKSã‹ã‚‰å…¬é–‹éµå–å¾—ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼‰â”‚ â”‚
â”‚  â”‚ 3. JWTç½²åæ¤œè¨¼                   â”‚ â”‚
â”‚  â”‚ 4. ã‚¯ãƒ¬ãƒ¼ãƒ æ¤œè¨¼ï¼ˆexp, iss, audï¼‰ â”‚ â”‚
â”‚  â”‚ 5. ãƒ–ãƒ©ãƒƒã‚¯ãƒªã‚¹ãƒˆç¢ºèªï¼ˆRedisï¼‰   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚ 2. æ¤œè¨¼çµæœ
        â”‚    æˆåŠŸ â†’ ãƒªã‚¯ã‚¨ã‚¹ãƒˆå‡¦ç†ç¶™ç¶š
        â”‚    å¤±æ•— â†’ 401 Unauthorized
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ãƒ¦ãƒ¼ã‚¶ãƒ¼  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3. ãƒˆãƒ¼ã‚¯ãƒ³ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒ•ãƒ­ãƒ¼

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ãƒ¦ãƒ¼ã‚¶ãƒ¼  â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
      â”‚ 1. ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥è¦æ±‚ï¼ˆrefresh_tokené€ä¿¡ï¼‰
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Auth Service                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ 1. ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼      â”‚ â”‚
â”‚  â”‚ 2. ãƒ–ãƒ©ãƒƒã‚¯ãƒªã‚¹ãƒˆç¢ºèª            â”‚ â”‚
â”‚  â”‚ 3. æ–°ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ç”Ÿæˆ        â”‚ â”‚
â”‚  â”‚ 4. æ–°ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ç”Ÿæˆ    â”‚ â”‚
â”‚  â”‚ 5. æ—§ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ã‚’ãƒ–ãƒ©ãƒƒã‚¯ãƒªã‚¹ãƒˆâ”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚ 2. æ–°ãƒˆãƒ¼ã‚¯ãƒ³ãƒšã‚¢è¿”å´
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ãƒ¦ãƒ¼ã‚¶ãƒ¼  â”‚ â”€â”€â†’ ãƒˆãƒ¼ã‚¯ãƒ³æ›´æ–°
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4. ãƒˆãƒ¼ã‚¯ãƒ³ç„¡åŠ¹åŒ–ãƒ•ãƒ­ãƒ¼

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ãƒ¦ãƒ¼ã‚¶ãƒ¼  â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
      â”‚ 1. ãƒ­ã‚°ã‚¢ã‚¦ãƒˆè¦æ±‚
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Auth Service                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ 1. ãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼                  â”‚ â”‚
â”‚  â”‚ 2. ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ãƒ–ãƒ©ãƒƒã‚¯ãƒªã‚¹ãƒˆâ”‚ â”‚
â”‚  â”‚ 3. ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ãƒ–ãƒ©ãƒƒã‚¯ãƒªã‚¹ãƒˆâ”‚ â”‚
â”‚  â”‚ 4. Redisã‚»ãƒƒã‚·ãƒ§ãƒ³å‰Šé™¤           â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚ 2. ãƒ­ã‚°ã‚¢ã‚¦ãƒˆæˆåŠŸ
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ãƒ¦ãƒ¼ã‚¶ãƒ¼  â”‚ â”€â”€â†’ ãƒˆãƒ¼ã‚¯ãƒ³ç ´æ£„
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è€ƒæ…®äº‹é …

### 1. ãƒˆãƒ¼ã‚¯ãƒ³ç›—é›£å¯¾ç­–

**httpOnly Cookieä½¿ç”¨**:
```typescript
// BFFã§ã®å®Ÿè£…ä¾‹
res.setHeader('Set-Cookie', [
  `access_token=${accessToken}; HttpOnly; Secure; SameSite=Strict; Path=/; Max-Age=900`,
  `refresh_token=${refreshToken}; HttpOnly; Secure; SameSite=Strict; Path=/api/auth/refresh; Max-Age=604800`
]);
```

**åˆ©ç‚¹**:
- JavaScriptã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ä¸å¯ï¼ˆXSSå¯¾ç­–ï¼‰
- HTTPSé€šä¿¡ã®ã¿ï¼ˆSecureå±æ€§ï¼‰
- CSRFå¯¾ç­–ï¼ˆSameSiteå±æ€§ï¼‰

### 2. ãƒªãƒ—ãƒ¬ã‚¤ã‚¢ã‚¿ãƒƒã‚¯å¯¾ç­–

**JTIï¼ˆJWT IDï¼‰ä½¿ç”¨**:
```python
# ãƒˆãƒ¼ã‚¯ãƒ³ç™ºè¡Œæ™‚
token_id = str(uuid.uuid4())
payload = {
    "jti": token_id,
    # ãã®ä»–ã®ã‚¯ãƒ¬ãƒ¼ãƒ ...
}

# ãƒ­ã‚°ã‚¢ã‚¦ãƒˆæ™‚
await redis.sadd(f"blacklist:{token_id}", "1", ex=3600)

# æ¤œè¨¼æ™‚
is_blacklisted = await redis.exists(f"blacklist:{token_id}")
if is_blacklisted:
    raise InvalidTokenError("Token has been revoked")
```

### 3. ã‚¯ãƒ­ãƒƒã‚¯ã‚¹ã‚­ãƒ¥ãƒ¼å¯¾ç­–

**æ™‚åˆ»æ¤œè¨¼ã«çŒ¶äºˆæœŸé–“ã‚’è¨­å®š**:
```python
# expï¼ˆæœ‰åŠ¹æœŸé™ï¼‰æ¤œè¨¼æ™‚ã«60ç§’ã®çŒ¶äºˆ
leeway = 60  # seconds

jwt.decode(
    token,
    public_key,
    algorithms=["RS256"],
    audience="fastapi-api",
    leeway=leeway
)
```

### 4. ã‚­ãƒ¼ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³

**å®šæœŸçš„ãªéµæ›´æ–°è¨ˆç”»**:
```
1. æ–°ã—ã„RSAã‚­ãƒ¼ãƒšã‚¢ç”Ÿæˆ
2. æ–°ã‚­ãƒ¼ã‚’JWKSã«è¿½åŠ ï¼ˆè¤‡æ•°ã‚­ãƒ¼ä¸¦å­˜ï¼‰
3. æ–°ãƒˆãƒ¼ã‚¯ãƒ³ã¯æ–°ã‚­ãƒ¼ã§ç½²å
4. æ—§ãƒˆãƒ¼ã‚¯ãƒ³ã®æœ‰åŠ¹æœŸé™åˆ‡ã‚Œã¾ã§å¾…æ©Ÿ
5. æ—§ã‚­ãƒ¼ã‚’JWKSã‹ã‚‰å‰Šé™¤
```

**å®Ÿè£…ä¾‹**:
```json
{
  "keys": [
    {
      "kid": "auth-service-key-2",
      "kty": "RSA",
      "use": "sig",
      "alg": "RS256",
      // æ–°ã‚­ãƒ¼ï¼ˆç¾åœ¨ä½¿ç”¨ä¸­ï¼‰
    },
    {
      "kid": "auth-service-key-1",
      "kty": "RSA",
      "use": "sig",
      "alg": "RS256",
      // æ—§ã‚­ãƒ¼ï¼ˆæ¤œè¨¼ã®ã¿ï¼‰
    }
  ]
}
```

---

## å®Ÿè£…ä¾‹

### Pythonï¼ˆãƒˆãƒ¼ã‚¯ãƒ³ç”Ÿæˆï¼‰

```python
from datetime import datetime, timedelta
from jose import jwt
import uuid

# ç§˜å¯†éµèª­ã¿è¾¼ã¿
with open("keys/private_key.pem", "r") as f:
    private_key = f.read()

def create_access_token(user_id: str, email: str, role: str) -> str:
    """ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ç”Ÿæˆ"""
    now = datetime.utcnow()
    payload = {
        "sub": user_id,
        "email": email,
        "role": role,
        "iss": "https://auth.example.com",
        "aud": "fastapi-api",
        "iat": int(now.timestamp()),
        "exp": int((now + timedelta(minutes=15)).timestamp()),
        "token_type": "access"
    }

    return jwt.encode(
        payload,
        private_key,
        algorithm="RS256",
        headers={"kid": "auth-service-key-1"}
    )

def create_refresh_token(user_id: str) -> str:
    """ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ç”Ÿæˆ"""
    now = datetime.utcnow()
    payload = {
        "sub": user_id,
        "iss": "https://auth.example.com",
        "aud": "fastapi-api",
        "iat": int(now.timestamp()),
        "exp": int((now + timedelta(days=7)).timestamp()),
        "token_type": "refresh",
        "jti": str(uuid.uuid4())
    }

    return jwt.encode(
        payload,
        private_key,
        algorithm="RS256",
        headers={"kid": "auth-service-key-1"}
    )
```

### Pythonï¼ˆãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼ï¼‰

```python
from jose import jwt, JWTError
import httpx

async def get_public_key() -> str:
    """JWKSçµŒç”±ã§å…¬é–‹éµå–å¾—"""
    async with httpx.AsyncClient() as client:
        response = await client.get(
            "http://localhost:8002/.well-known/jwks.json"
        )
        jwks = response.json()

        # kid="auth-service-key-1"ã®å…¬é–‹éµã‚’å–å¾—
        key = next(k for k in jwks["keys"] if k["kid"] == "auth-service-key-1")
        return key

async def verify_token(token: str) -> dict:
    """ãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼"""
    try:
        # JWKSã‹ã‚‰å…¬é–‹éµå–å¾—
        public_key = await get_public_key()

        # ãƒˆãƒ¼ã‚¯ãƒ³ãƒ‡ã‚³ãƒ¼ãƒ‰ï¼†æ¤œè¨¼
        payload = jwt.decode(
            token,
            public_key,
            algorithms=["RS256"],
            audience="fastapi-api",
            issuer="https://auth.example.com"
        )

        # ãƒˆãƒ¼ã‚¯ãƒ³ã‚¿ã‚¤ãƒ—ç¢ºèª
        if payload.get("token_type") != "access":
            raise ValueError("Invalid token type")

        return payload

    except JWTError as e:
        raise ValueError(f"Invalid token: {str(e)}")
```

### TypeScriptï¼ˆãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼ï¼‰

```typescript
import jwt from 'jsonwebtoken';
import jwksClient from 'jwks-rsa';

// JWKSã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆè¨­å®š
const client = jwksClient({
  jwksUri: 'http://localhost:8002/.well-known/jwks.json',
  cache: true,
  cacheMaxAge: 3600000, // 1æ™‚é–“
});

// å…¬é–‹éµå–å¾—
function getKey(header: jwt.JwtHeader, callback: jwt.SigningKeyCallback) {
  client.getSigningKey(header.kid, (err, key) => {
    if (err) {
      callback(err);
      return;
    }
    const signingKey = key?.getPublicKey();
    callback(null, signingKey);
  });
}

// ãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼
export async function verifyToken(token: string): Promise<jwt.JwtPayload> {
  return new Promise((resolve, reject) => {
    jwt.verify(
      token,
      getKey,
      {
        algorithms: ['RS256'],
        audience: 'fastapi-api',
        issuer: 'https://auth.example.com',
      },
      (err, decoded) => {
        if (err) {
          reject(err);
          return;
        }
        resolve(decoded as jwt.JwtPayload);
      }
    );
  });
}
```

---

## é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- [èªè¨¼ã‚µãƒ¼ãƒ“ã‚¹æ¦‚è¦](./01-overview.md)
- [èªè¨¼APIä»•æ§˜](./02-api-specification.md)
- [ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å®Ÿè£…](./05-security-implementation.md)
- [JWTæ¤œè¨¼ãƒ•ãƒ­ãƒ¼](../08-integration/04-jwt-verification.md)
- [èªè¨¼ãƒ•ãƒ­ãƒ¼çµ±åˆ](../08-integration/02-authentication-flow.md)