# 脆弱性管理

**バージョン**: 1.0.0
**最終更新**: 2025-09-30

## 目次
- [概要](#概要)
- [依存関係スキャン](#依存関係スキャン)
- [SQLインジェクション防止](#sqlインジェクション防止)
- [XSS防止](#xss防止)
- [パストラバーサル防止](#パストラバーサル防止)
- [セキュリティアップデート](#セキュリティアップデート)

---

## 概要

### 脆弱性管理の重要性

ソフトウェアの脆弱性は、攻撃者がシステムに侵入するための主要な経路です。ai-micro-service システムでは、以下のアプローチで脆弱性を管理します:

1. **予防**: セキュアコーディング、依存関係管理
2. **検出**: 自動スキャン、コードレビュー
3. **対応**: パッチ適用、インシデント対応
4. **監視**: 継続的なセキュリティ監視

---

## 依存関係スキャン

### Python 依存関係（Poetry）

#### pip-audit

**インストール**:
```bash
pip install pip-audit
```

**実行**:
```bash
cd ai-micro-api-auth
poetry run pip-audit
```

**出力例**:
```
Found 2 known vulnerabilities in 1 package
Name    Version  ID              Fix Versions
------  -------  --------------  ------------
urllib3 1.26.5   GHSA-q2q7-5pp4  1.26.18,2.0.7
urllib3 1.26.5   GHSA-g4mx-q9vg  1.26.17,2.0.6
```

#### Safety

**インストール**:
```bash
poetry add --dev safety
```

**実行**:
```bash
poetry run safety check
```

#### Snyk

**インストール**:
```bash
npm install -g snyk
```

**実行**:
```bash
cd ai-micro-api-auth
snyk test
snyk monitor  # プロジェクト監視
```

### Node.js 依存関係（npm）

#### npm audit

**実行**:
```bash
cd ai-micro-front-user
npm audit

# 自動修正
npm audit fix

# 強制修正（破壊的変更を含む）
npm audit fix --force
```

**出力例**:
```
found 3 vulnerabilities (1 moderate, 2 high)
  run `npm audit fix` to fix 2 of them.
  1 vulnerability requires manual review. See the full report for details.
```

#### Snyk

```bash
cd ai-micro-front-user
snyk test
```

### GitHub Dependabot

**有効化**: `.github/dependabot.yml`

```yaml
version: 2
updates:
  # Python 依存関係
  - package-ecosystem: "pip"
    directory: "/ai-micro-api-auth"
    schedule:
      interval: "weekly"
    open-pull-requests-limit: 10

  # npm 依存関係
  - package-ecosystem: "npm"
    directory: "/ai-micro-front-user"
    schedule:
      interval: "weekly"
    open-pull-requests-limit: 10

  # Docker 依存関係
  - package-ecosystem: "docker"
    directory: "/"
    schedule:
      interval: "weekly"
```

### CI/CD統合

**GitHub Actions**: `.github/workflows/security-scan.yml`

```yaml
name: Security Scan

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '0 0 * * 0'  # 毎週日曜日

jobs:
  python-security:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install Poetry
        run: |
          curl -sSL https://install.python-poetry.org | python3 -
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Install dependencies
        working-directory: ./ai-micro-api-auth
        run: poetry install

      - name: Run pip-audit
        working-directory: ./ai-micro-api-auth
        run: poetry run pip-audit

      - name: Run Bandit
        working-directory: ./ai-micro-api-auth
        run: poetry run bandit -r app/

  node-security:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install dependencies
        working-directory: ./ai-micro-front-user
        run: npm ci

      - name: Run npm audit
        working-directory: ./ai-micro-front-user
        run: npm audit --audit-level=moderate

  snyk-security:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Run Snyk
        uses: snyk/actions/python@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          command: test
          args: --file=ai-micro-api-auth/pyproject.toml
```

---

## SQLインジェクション防止

### ORM使用（推奨）

**SQLAlchemy ORM**:

```python
# ✅ 安全（ORM使用）
from sqlalchemy import select

result = await db.execute(
    select(User).where(User.email == request.email)
)
user = result.scalar_one_or_none()
```

### パラメータ化クエリ

**Raw SQL使用時**:

```python
# ✅ 安全（パラメータ化）
from sqlalchemy import text

result = await db.execute(
    text("SELECT * FROM users WHERE email = :email"),
    {"email": request.email}
)

# ❌ 危険（文字列連結）
query = f"SELECT * FROM users WHERE email = '{request.email}'"
result = await db.execute(text(query))
```

### 入力検証

**Pydantic バリデーション**:

```python
from pydantic import BaseModel, EmailStr, validator

class LoginRequest(BaseModel):
    email: EmailStr  # メールアドレス形式を検証
    password: str

    @validator('email')
    def validate_email(cls, v):
        # SQLキーワードチェック
        sql_keywords = ['SELECT', 'INSERT', 'UPDATE', 'DELETE', 'DROP', 'UNION']
        if any(keyword in v.upper() for keyword in sql_keywords):
            raise ValueError('Invalid email format')
        return v
```

### エスケープ処理

```python
import re

def sanitize_input(value: str) -> str:
    """Sanitize user input"""
    # SQLコメント除去
    value = re.sub(r'--.*$', '', value)
    value = re.sub(r'/\*.*?\*/', '', value, flags=re.DOTALL)

    # シングルクォートエスケープ
    value = value.replace("'", "''")

    return value
```

---

## XSS防止

### 入力検証

**HTMLタグ除去**:

```python
import re
from pydantic import BaseModel, validator

class ProfileUpdate(BaseModel):
    name: str
    bio: str

    @validator('name', 'bio')
    def sanitize_html(cls, v):
        # HTMLタグ除去
        clean = re.sub(r'<[^>]*>', '', v)
        # スクリプトタグ除去
        clean = re.sub(r'<script.*?</script>', '', clean, flags=re.DOTALL | re.IGNORECASE)
        return clean
```

### 出力エスケープ（React）

**自動エスケープ**:

```tsx
// ✅ 安全（自動エスケープ）
function UserProfile({ user }) {
  return <div>{user.name}</div>;
}

// ❌ 危険
function UserProfile({ user }) {
  return <div dangerouslySetInnerHTML={{__html: user.name}} />;
}

// ✅ サニタイズライブラリ使用
import DOMPurify from 'dompurify';

function UserProfile({ user }) {
  const cleanHTML = DOMPurify.sanitize(user.bio);
  return <div dangerouslySetInnerHTML={{__html: cleanHTML}} />;
}
```

### Content Security Policy

```python
response.headers["Content-Security-Policy"] = (
    "default-src 'self'; "
    "script-src 'self'; "
    "style-src 'self' 'unsafe-inline'; "
    "img-src 'self' data: https:; "
    "object-src 'none';"
)
```

---

## パストラバーサル防止

### ファイルアップロード

**安全な実装**:

```python
from pathlib import Path
import uuid
import os

UPLOAD_DIR = Path("/var/www/uploads")

async def save_uploaded_file(file: UploadFile) -> str:
    """Save uploaded file safely"""

    # ファイル名をUUIDで生成（ユーザー入力を使用しない）
    file_extension = Path(file.filename).suffix
    safe_filename = f"{uuid.uuid4()}{file_extension}"

    # アップロードディレクトリ外へのアクセスを防止
    file_path = UPLOAD_DIR / safe_filename
    file_path = file_path.resolve()

    if not str(file_path).startswith(str(UPLOAD_DIR.resolve())):
        raise ValueError("Invalid file path")

    # ファイル保存
    with open(file_path, "wb") as f:
        content = await file.read()
        f.write(content)

    return safe_filename
```

**危険な実装**:

```python
# ❌ 危険（ユーザー入力をそのまま使用）
async def save_uploaded_file(file: UploadFile):
    file_path = f"/var/www/uploads/{file.filename}"  # ../../../etc/passwd 可能
    with open(file_path, "wb") as f:
        f.write(await file.read())
```

### ファイル読み込み

**安全な実装**:

```python
async def get_document(document_id: str):
    """Get document by ID"""

    # データベースからファイルパス取得
    document = await db.get(Document, document_id)
    if not document:
        raise HTTPException(status_code=404, detail="Document not found")

    # ファイルパス検証
    file_path = Path(document.file_path).resolve()
    if not str(file_path).startswith(str(UPLOAD_DIR.resolve())):
        raise HTTPException(status_code=403, detail="Access denied")

    # ファイル読み込み
    return FileResponse(file_path)
```

### 許可リスト方式

```python
ALLOWED_EXTENSIONS = {'.pdf', '.docx', '.txt', '.jpg', '.png'}

def validate_file_extension(filename: str) -> bool:
    """Validate file extension using allowlist"""
    extension = Path(filename).suffix.lower()
    return extension in ALLOWED_EXTENSIONS

@router.post("/upload")
async def upload_file(file: UploadFile):
    if not validate_file_extension(file.filename):
        raise HTTPException(
            status_code=400,
            detail=f"File type not allowed. Allowed types: {ALLOWED_EXTENSIONS}"
        )

    # ファイル保存
    ...
```

---

## セキュリティアップデート

### 定期的なアップデート

**スケジュール**:
- 週次: 依存関係スキャン
- 月次: セキュリティパッチ適用
- 四半期: メジャーバージョンアップデート検討

### パッチ適用プロセス

1. **脆弱性の確認**:
   ```bash
   poetry run pip-audit
   npm audit
   ```

2. **テスト環境での検証**:
   ```bash
   # 依存関係更新
   poetry update <package>
   npm update <package>

   # テスト実行
   poetry run pytest
   npm test
   ```

3. **本番環境への適用**:
   ```bash
   # デプロイ
   git tag v1.2.3
   git push origin v1.2.3
   ```

4. **モニタリング**:
   - エラーログ確認
   - パフォーマンス監視

### 緊急パッチ

**重大な脆弱性の場合**:

1. **即座の対応**:
   - サービス停止の検討
   - ファイアウォールルールの追加
   - 一時的な回避策

2. **パッチ適用**:
   - 最優先でアップデート
   - 緊急リリース

3. **事後対応**:
   - インシデントレポート作成
   - 再発防止策の実施

---

## セキュリティツール

### Bandit（Python静的解析）

**インストール**:
```bash
poetry add --dev bandit
```

**実行**:
```bash
poetry run bandit -r app/ -f json -o bandit-report.json
```

**検出例**:
```python
# ❌ Bandit が警告
password = "hardcoded_password"  # B105: hardcoded_password_string

# ✅ 環境変数から取得
password = os.getenv("DATABASE_PASSWORD")
```

### ESLint Security Plugin（JavaScript）

**インストール**:
```bash
npm install --save-dev eslint-plugin-security
```

**設定**: `.eslintrc.json`
```json
{
  "plugins": ["security"],
  "extends": ["plugin:security/recommended"]
}
```

### OWASP ZAP

**動的アプリケーションセキュリティテスト（DAST）**:

```bash
# Docker で実行
docker run -t owasp/zap2docker-stable zap-baseline.py \
  -t http://localhost:3002 \
  -r zap-report.html
```

---

## セキュリティベストプラクティス

### 1. セキュアコーディング

**原則**:
- ✅ 入力は常に検証
- ✅ 出力は常にエスケープ
- ✅ ORM を使用
- ✅ パラメータ化クエリ

### 2. 依存関係管理

**原則**:
- ✅ 定期的なスキャン
- ✅ 自動アップデート（Dependabot）
- ✅ バージョン固定（lockファイル）

### 3. コードレビュー

**チェック項目**:
- [ ] 入力検証の実装
- [ ] SQLインジェクション対策
- [ ] XSS対策
- [ ] ハードコードされた認証情報
- [ ] 適切なエラーハンドリング

---

## トラブルシューティング

### 問題: 依存関係の脆弱性が修正できない

**原因**: 依存関係の依存関係に脆弱性

**対策**:
```bash
# 依存関係ツリー確認
poetry show --tree

# 特定パッケージを除外
poetry add <alternative-package>
```

### 問題: npm audit で大量の警告

**原因**: 開発依存関係の脆弱性

**対策**:
```bash
# 本番依存関係のみスキャン
npm audit --omit=dev
```

---

## 関連ドキュメント

- [01-security-overview.md](./01-security-overview.md) - セキュリティ概要
- [02-authentication-security.md](./02-authentication-security.md) - 認証セキュリティ
- [10-security-checklist.md](./10-security-checklist.md) - セキュリティチェックリスト

---

**次のステップ**: [10-security-checklist.md](./10-security-checklist.md) を参照して、総合的なセキュリティチェックリストを確認してください。
