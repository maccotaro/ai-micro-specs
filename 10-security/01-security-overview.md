# セキュリティ概要

**バージョン**: 1.0.0
**最終更新**: 2025-09-30

## 目次
- [概要](#概要)
- [セキュリティアーキテクチャ](#セキュリティアーキテクチャ)
- [Defense in Depth戦略](#defense-in-depth戦略)
- [セキュリティコンポーネント](#セキュリティコンポーネント)
- [脅威モデル](#脅威モデル)
- [セキュリティポリシー](#セキュリティポリシー)
- [コンプライアンス](#コンプライアンス)

---

## 概要

### セキュリティの重要性

ai-micro-service マイクロサービスアーキテクチャは、ユーザー認証情報、個人情報、ドキュメントデータなどの機密情報を扱います。システム全体のセキュリティは多層防御（Defense in Depth）戦略に基づいて設計されており、各層で異なるセキュリティコントロールを実装しています。

### セキュリティ目標

1. **機密性（Confidentiality）**: 認証情報、個人情報、ドキュメントデータの保護
2. **完全性（Integrity）**: データの改ざん防止、トランザクションの整合性保証
3. **可用性（Availability）**: DoS攻撃からの保護、システムの継続稼働
4. **認証（Authentication）**: ユーザーの正確な識別
5. **認可（Authorization）**: 適切なアクセス制御
6. **監査（Auditing）**: セキュリティイベントのログ記録

---

## セキュリティアーキテクチャ

### システム全体のセキュリティ構成図

```
┌─────────────────────────────────────────────────────────────────┐
│  セキュリティ層                                                    │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  Layer 7: アプリケーション層セキュリティ                   │   │
│  │  - JWT認証・認可 (RS256)                                 │   │
│  │  - RBAC (user, admin, super_admin)                      │   │
│  │  - 入力検証・サニタイゼーション                            │   │
│  │  - CSRF保護                                              │   │
│  └─────────────────────────────────────────────────────────┘   │
│                           ↓                                     │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  Layer 6: API層セキュリティ                               │   │
│  │  - CORS設定                                              │   │
│  │  - レート制限                                             │   │
│  │  - セキュリティヘッダー                                    │   │
│  │  - httpOnly Cookie                                       │   │
│  └─────────────────────────────────────────────────────────┘   │
│                           ↓                                     │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  Layer 5: トランスポート層セキュリティ                      │   │
│  │  - TLS 1.3 / HTTPS                                       │   │
│  │  - 証明書検証                                             │   │
│  └─────────────────────────────────────────────────────────┘   │
│                           ↓                                     │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  Layer 4: ネットワーク層セキュリティ                        │   │
│  │  - Docker ネットワーク分離                                │   │
│  │  - ファイアウォールルール                                  │   │
│  │  - ポート制限                                             │   │
│  └─────────────────────────────────────────────────────────┘   │
│                           ↓                                     │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  Layer 3: データ層セキュリティ                             │   │
│  │  - パスワードハッシング (bcrypt)                           │   │
│  │  - データベース暗号化                                      │   │
│  │  - Redis認証                                              │   │
│  │  - 機密データマスキング                                    │   │
│  └─────────────────────────────────────────────────────────┘   │
│                           ↓                                     │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  Layer 2: インフラ層セキュリティ                           │   │
│  │  - Docker コンテナ分離                                    │   │
│  │  - ボリューム権限管理                                      │   │
│  │  - 環境変数保護                                            │   │
│  └─────────────────────────────────────────────────────────┘   │
│                           ↓                                     │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  Layer 1: 物理層セキュリティ                              │   │
│  │  - ホストOS保護                                           │   │
│  │  - アクセス制御                                            │   │
│  └─────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
```

### マイクロサービス間のセキュリティフロー

```
┌──────────────┐         ┌──────────────┐         ┌──────────────┐
│ User Frontend│  HTTPS  │     BFF      │  JWT    │Auth Service  │
│  (Port 3002) │ ──────→ │  (API Proxy) │ ──────→ │ (Port 8002)  │
└──────────────┘         └──────────────┘         └──────────────┘
                              │                           │
                              │ JWT Validation            │ JWT Signing
                              ↓                           │ RS256
┌──────────────┐         ┌──────────────┐                │
│Admin Frontend│  HTTPS  │User API      │  JWKS Fetch    │
│  (Port 3003) │ ──────→ │ (Port 8001)  │ ←──────────────┘
└──────────────┘         └──────────────┘
                              ↓
                         ┌──────────────┐
                         │Admin API     │  Password Auth
                         │ (Port 8003)  │ ←─────────────┐
                         └──────────────┘                │
                              ↓                          │
                    ┌─────────┴─────────┐                │
                    │                   │                │
              ┌─────┴──────┐      ┌────┴──────┐    ┌────┴─────┐
              │ PostgreSQL │      │   Redis   │    │  Secrets │
              │ (Port 5432)│      │(Port 6379)│    │   Store  │
              └────────────┘      └───────────┘    └──────────┘
                   TLS                Redis Auth      Encrypted
```

---

## Defense in Depth戦略

### 多層防御の原則

単一の防御メカニズムに依存せず、複数の独立したセキュリティ層を実装することで、一つの層が突破されても他の層で保護します。

### 実装されている防御層

#### 1. 認証層（Authentication Layer）

**目的**: ユーザーの身元確認

**実装**:
- JWT トークンベース認証（RS256署名）
- パスワードハッシング（bcrypt, 10 rounds）
- ブルートフォース攻撃保護（ログイン試行回数制限）

#### 2. 認可層（Authorization Layer）

**目的**: リソースへのアクセス制御

**実装**:
- ロールベースアクセス制御（RBAC）
- JWT クレーム検証（iss, aud, exp, sub）
- サービス間認可

#### 3. トランスポート層（Transport Layer）

**目的**: 通信の暗号化

**実装**:
- TLS/HTTPS（本番環境）
- 証明書ピンニング（推奨）
- HSTS ヘッダー

#### 4. データ層（Data Layer）

**目的**: 保管データの保護

**実装**:
- パスワードハッシュ保存（平文保存禁止）
- Redis パスワード認証
- データベース暗号化（推奨）

#### 5. ネットワーク層（Network Layer）

**目的**: 不正アクセスの防止

**実装**:
- Docker ネットワーク分離
- ポート公開制限
- ファイアウォールルール（本番環境）

#### 6. アプリケーション層（Application Layer）

**目的**: アプリケーションレベルの脆弱性対策

**実装**:
- 入力検証・サニタイゼーション
- SQLインジェクション防止（ORM使用）
- XSS防止（出力エスケープ）
- CSRF保護

---

## セキュリティコンポーネント

### 1. JWT（JSON Web Token）

**アルゴリズム**: RS256（RSA署名 + SHA-256）

**特徴**:
- 非対称鍵暗号による署名
- 秘密鍵は Auth Service のみが保持
- 公開鍵は JWKS エンドポイントで配布
- トークンの改ざん検出可能

**詳細**: [02-authentication-security.md](./02-authentication-security.md)

### 2. bcrypt パスワードハッシング

**アルゴリズム**: bcrypt（cost factor: 10）

**特徴**:
- ソルト自動生成
- レインボーテーブル攻撃耐性
- 計算コスト調整可能
- 将来的な強度向上可能

**詳細**: [07-password-policy.md](./07-password-policy.md)

### 3. CORS（Cross-Origin Resource Sharing）

**設定**:
```python
app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],  # 本番環境では具体的なオリジンを指定
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)
```

**詳細**: [06-cors-and-headers.md](./06-cors-and-headers.md)

### 4. httpOnly Cookie

**特徴**:
- JavaScript からアクセス不可
- XSS 攻撃によるトークン窃取防止
- ブラウザが自動的に送信

**設定例**:
```typescript
res.setHeader('Set-Cookie', `token=${token}; HttpOnly; Secure; SameSite=Strict`);
```

### 5. Redis セッション管理

**用途**:
- アクティブセッション管理
- トークンブラックリスト
- レート制限カウンター

**キーパターン**:
- `session:<user_id>:<session_id>`
- `blacklist:access:<jti>`
- `blacklist:refresh:<jti>`

---

## 脅威モデル

### STRIDE モデル分析

#### Spoofing（なりすまし）

**脅威**: 攻撃者が正規ユーザーになりすます

**対策**:
- JWT トークン検証
- パスワード強度要件
- ブルートフォース攻撃保護

#### Tampering（改ざん）

**脅威**: データやトークンの改ざん

**対策**:
- JWT 署名検証（RS256）
- データベーストランザクション（ACID特性）
- HTTPSによる通信保護

#### Repudiation（否認）

**脅威**: 操作の否認

**対策**:
- システムログ記録（system_logs テーブル）
- ログイン履歴（login_logs テーブル）
- 監査ログ

#### Information Disclosure（情報漏えい）

**脅威**: 機密情報の不正開示

**対策**:
- パスワードハッシング
- HTTPSによる暗号化
- 適切なエラーメッセージ（詳細情報を漏らさない）

#### Denial of Service（サービス拒否）

**脅威**: システムの可用性への攻撃

**対策**:
- レート制限
- 接続プール設定
- タイムアウト設定

#### Elevation of Privilege（権限昇格）

**脅威**: 不正な権限取得

**対策**:
- RBAC実装
- JWT ロールクレーム検証
- 最小権限の原則

### OWASP Top 10 対策状況

| 脅威 | 対策状況 | 実装内容 |
|-----|---------|---------|
| A01: アクセス制御の不備 | ✅ 対策済み | RBAC, JWT検証 |
| A02: 暗号化の失敗 | ✅ 対策済み | bcrypt, HTTPS, RS256 |
| A03: インジェクション | ✅ 対策済み | SQLAlchemy ORM, パラメータ化クエリ |
| A04: 安全でない設計 | ✅ 対策済み | セキュアバイデザイン |
| A05: セキュリティ設定ミス | ⚠️ 注意必要 | 本番環境設定要確認 |
| A06: 脆弱で古いコンポーネント | ⚠️ 注意必要 | 定期的な依存関係更新 |
| A07: 識別と認証の失敗 | ✅ 対策済み | JWT, パスワードポリシー |
| A08: ソフトウェアとデータの整合性の不備 | ⚠️ 注意必要 | CI/CD署名、依存関係検証 |
| A09: セキュリティログとモニタリングの失敗 | ⚠️ 注意必要 | ログ強化推奨 |
| A10: サーバーサイドリクエストフォージェリ | ✅ 対策済み | 入力検証、URL検証 |

---

## セキュリティポリシー

### パスワードポリシー

- **最小文字数**: 8文字以上
- **複雑さ要件**: 推奨（英数字+記号）
- **有効期限**: 設定可能（デフォルト: 無期限）
- **再利用禁止**: 設定可能（デフォルト: 無効）
- **ロックアウトポリシー**: 5回失敗でアカウントロック

詳細: [07-password-policy.md](./07-password-policy.md)

### トークンポリシー

- **アクセストークン有効期限**: 15分
- **リフレッシュトークン有効期限**: 30日
- **トークンローテーション**: 必須
- **ブラックリスト**: ログアウト時に即時無効化

詳細: [08-token-security.md](./08-token-security.md)

### アクセス制御ポリシー

- **デフォルトロール**: `user`
- **管理者ロール**: `admin`, `super_admin`
- **最小権限の原則**: 必要最小限の権限を付与
- **職務分離**: 異なる役割に異なる権限

詳細: [03-authorization-security.md](./03-authorization-security.md)

---

## コンプライアンス

### GDPR（EU一般データ保護規則）

**該当する可能性のある個人データ**:
- メールアドレス（users.email）
- 氏名（profiles.first_name, last_name）
- 住所（profiles.address）
- 電話番号（profiles.phone）

**必要な対応**:
- ✅ データ暗号化（パスワードハッシング）
- ✅ アクセス制御（RBAC）
- ⚠️ 同意管理（未実装）
- ⚠️ データポータビリティ（未実装）
- ⚠️ 削除権（論理削除の実装推奨）

### PCI DSS（クレジットカード業界データセキュリティ基準）

**該当状況**: 現在は決済機能なし

**将来の実装時の要件**:
- クレジットカード情報の直接保存禁止
- 決済代行サービス（Stripe, PayPal等）の利用
- トークン化の実装

---

## セキュリティ監視

### ログ記録対象

1. **認証イベント**:
   - ログイン成功/失敗
   - ログアウト
   - トークンリフレッシュ

2. **認可イベント**:
   - 権限エラー（403 Forbidden）
   - 不正アクセス試行

3. **システムイベント**:
   - サービス起動/停止
   - データベース接続エラー
   - Redis接続エラー

### アラート基準

- **即時アラート**:
  - ブルートフォース攻撃検出
  - SQLインジェクション試行
  - 大量の認証エラー

- **定期レポート**:
  - 失敗したログイン試行
  - 権限エラーの傾向
  - システムエラー統計

---

## セキュリティベストプラクティス

### 開発環境

1. **環境変数管理**:
   - `.env` ファイルを `.gitignore` に追加
   - サンプル用 `.env.example` のみコミット
   - 本番環境の認証情報を開発環境で使用しない

2. **依存関係管理**:
   - Poetry / npm での依存関係固定
   - 定期的なセキュリティアップデート
   - 脆弱性スキャン実施

3. **コードレビュー**:
   - セキュリティ観点のレビュー
   - ハードコードされた認証情報のチェック
   - SQLクエリの確認

### 本番環境

1. **環境設定**:
   - HTTPS 必須
   - 強固なパスワード設定
   - CORS オリジン制限
   - セキュリティヘッダー設定

2. **インフラ**:
   - ファイアウォール設定
   - VPC/サブネット分離
   - DDoS保護
   - WAF（Web Application Firewall）導入検討

3. **運用**:
   - 定期的なバックアップ
   - セキュリティパッチの適用
   - ログ監視
   - インシデント対応計画

---

## 既知の制限事項

### 開発環境の制約

1. **HTTPS未使用**:
   - 開発環境では HTTP を使用
   - 本番環境では必ず HTTPS を使用すること

2. **CORS設定が緩い**:
   - 開発環境では `allow_origins=["*"]`
   - 本番環境では具体的なオリジンを指定すること

3. **Redis認証**:
   - パスワード認証のみ
   - TLS接続は未設定（本番環境で推奨）

### 今後の改善予定

1. **マルチファクタ認証（MFA）**:
   - TOTP（Time-based One-Time Password）
   - SMS認証
   - 生体認証

2. **セキュリティヘッダー強化**:
   - Content Security Policy（CSP）
   - X-Frame-Options
   - X-Content-Type-Options

3. **監査ログ強化**:
   - 詳細なアクセスログ
   - データ変更履歴
   - コンプライアンスレポート

---

## 関連ドキュメント

### セキュリティ詳細
- [02-authentication-security.md](./02-authentication-security.md) - 認証セキュリティ
- [03-authorization-security.md](./03-authorization-security.md) - 認可セキュリティ
- [04-data-protection.md](./04-data-protection.md) - データ保護
- [05-network-security.md](./05-network-security.md) - ネットワークセキュリティ
- [06-cors-and-headers.md](./06-cors-and-headers.md) - CORS とセキュリティヘッダー
- [07-password-policy.md](./07-password-policy.md) - パスワードポリシー
- [08-token-security.md](./08-token-security.md) - トークンセキュリティ
- [09-vulnerability-management.md](./09-vulnerability-management.md) - 脆弱性管理
- [10-security-checklist.md](./10-security-checklist.md) - セキュリティチェックリスト

### 関連システムドキュメント
- [Auth Service](/01-auth-service/01-overview.md) - 認証サービス概要
- [Database Security](/06-database/01-overview.md#セキュリティ) - データベースセキュリティ
- [Redis Security](/07-redis/01-overview.md) - Redis セキュリティ

---

**次のステップ**: [02-authentication-security.md](./02-authentication-security.md) を参照して、JWT認証の詳細な実装を確認してください。