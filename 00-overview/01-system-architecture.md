# システム全体アーキテクチャ

**作成日**: 2025-09-30
**最終更新**: 2025-09-30
**対象バージョン**: v1.0

## 📋 目次

- [概要](#概要)
- [アーキテクチャスタイル](#アーキテクチャスタイル)
- [サービス構成](#サービス構成)
- [レイヤー構造](#レイヤー構造)
- [通信パターン](#通信パターン)
- [データフロー](#データフロー)
- [スケーラビリティ設計](#スケーラビリティ設計)
- [障害対策](#障害対策)

---

## 概要

ai-micro-serviceは、マイクロサービスアーキテクチャに基づく認証・ユーザー管理・ドキュメント処理システムです。7つの主要サービスが協調動作し、エンタープライズグレードの機能を提供します。

### システムの目的

- **認証・認可**: JWT方式による堅牢な認証基盤
- **ユーザー管理**: プロフィール情報の管理と更新
- **ドキュメント処理**: OCR処理と階層構造解析
- **管理機能**: システム全体の管理とモニタリング

---

## アーキテクチャスタイル

### マイクロサービスアーキテクチャ

本システムは以下の原則に基づいています：

1. **サービスの独立性**
   - 各サービスは独立してデプロイ可能
   - サービスごとに専用データベースを保有
   - 疎結合な設計

2. **ドメイン駆動設計（DDD）**
   - 認証ドメイン（Auth Service）
   - ユーザードメイン（User API）
   - 管理ドメイン（Admin API）
   - フロントエンドドメイン（BFF層）

3. **API Gateway + BFFパターン**
   - フロントエンドはBFF（Backend for Frontend）として機能
   - バックエンドサービスへのリクエストをプロキシ
   - JWT管理とセッション管理を担当

4. **イベント駆動アーキテクチャ（部分採用）**
   - Redisを使用した非同期処理
   - キャッシュ無効化イベント
   - セッション状態の共有

---

## サービス構成

### 全体構成図

```
┌─────────────────────────────────────────────────────────────┐
│                         クライアント層                         │
│  ┌──────────────────────┐    ┌──────────────────────┐      │
│  │ User Browser         │    │ Admin Browser        │      │
│  │ (localhost:3002)     │    │ (localhost:3003)     │      │
│  └──────────────────────┘    └──────────────────────┘      │
└───────────────┬──────────────────────┬──────────────────────┘
                │                      │
                ▼                      ▼
┌───────────────────────────────────────────────────────────────┐
│                         BFF層（Next.js）                       │
│  ┌──────────────────────┐    ┌──────────────────────┐        │
│  │ User Frontend BFF    │    │ Admin Frontend BFF   │        │
│  │ Port: 3002           │    │ Port: 3003           │        │
│  │ - API Proxy          │    │ - API Proxy          │        │
│  │ - JWT Cookie管理     │    │ - JWT Cookie管理     │        │
│  │ - SSR/CSR            │    │ - SSR/CSR            │        │
│  └──────────────────────┘    └──────────────────────┘        │
└───────┬──────────────────┬───────────┬───────────────────────┘
        │                  │           │
        ▼                  ▼           ▼
┌───────────────────────────────────────────────────────────────┐
│                      バックエンドサービス層                      │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐          │
│  │ Auth Service│  │ User API    │  │ Admin API   │          │
│  │ Port: 8002  │  │ Port: 8001  │  │ Port: 8003  │          │
│  │             │  │             │  │             │          │
│  │ - JWT発行   │  │ - Profile   │  │ - Document  │          │
│  │ - 認証      │  │   管理      │  │   処理      │          │
│  │ - ユーザー  │  │ - JWT検証   │  │ - OCR       │          │
│  │   登録      │  │             │  │ - JWT検証   │          │
│  └─────────────┘  └─────────────┘  └─────────────┘          │
└────┬────────────────┬────────────────┬────────────────────────┘
     │                │                │
     ▼                ▼                ▼
┌───────────────────────────────────────────────────────────────┐
│                      データストレージ層                          │
│  ┌──────────────────────────────────────────────┐             │
│  │ PostgreSQL (Port: 5432)                      │             │
│  │ ┌──────────┐ ┌──────────┐ ┌──────────┐     │             │
│  │ │ authdb   │ │ apidb    │ │ admindb  │     │             │
│  │ │ - users  │ │ - profiles│ │ - docs   │     │             │
│  │ │ - roles  │ │           │ │ - ocr    │     │             │
│  │ └──────────┘ └──────────┘ └──────────┘     │             │
│  └──────────────────────────────────────────────┘             │
│                                                                │
│  ┌──────────────────────────────────────────────┐             │
│  │ Redis (Port: 6379)                           │             │
│  │ - Sessions                                   │             │
│  │ - Token Blacklist                            │             │
│  │ - Profile Cache                              │             │
│  └──────────────────────────────────────────────┘             │
└───────────────────────────────────────────────────────────────┘
```

### サービス一覧

| サービス名 | ポート | 技術スタック | 役割 | データストア |
|-----------|--------|------------|------|-------------|
| User Frontend BFF | 3002 | Next.js 15, TypeScript | ユーザー向けUI/BFF | - |
| Admin Frontend BFF | 3003 | Next.js 15, TypeScript | 管理者向けUI/BFF | - |
| Auth Service | 8002 | FastAPI, Python 3.11 | 認証・JWT発行 | authdb, Redis |
| User API | 8001 | FastAPI, Python 3.11 | ユーザープロフィール管理 | apidb, Redis |
| Admin API | 8003 | FastAPI, Python 3.11 | 管理・ドキュメント処理 | admindb, Redis |
| PostgreSQL | 5432 | PostgreSQL 15 | リレーショナルDB | - |
| Redis | 6379 | Redis 7 | キャッシュ・セッション | - |

---

## レイヤー構造

### 4層アーキテクチャ

```
┌────────────────────────────────────────────────┐
│ Presentation Layer (プレゼンテーション層)        │
│ - Next.js Pages                                │
│ - React Components                             │
│ - UI State Management                          │
└────────────────────────────────────────────────┘
                    ↓
┌────────────────────────────────────────────────┐
│ BFF Layer (Backend for Frontend層)             │
│ - API Routes (/api/*)                          │
│ - Request Proxy                                │
│ - JWT Cookie Management                        │
│ - Response Transformation                      │
└────────────────────────────────────────────────┘
                    ↓
┌────────────────────────────────────────────────┐
│ Application Layer (アプリケーション層)          │
│ - FastAPI Routers                              │
│ - Business Logic                               │
│ - JWT Validation                               │
│ - Service Orchestration                        │
└────────────────────────────────────────────────┘
                    ↓
┌────────────────────────────────────────────────┐
│ Data Layer (データ層)                           │
│ - PostgreSQL (authdb, apidb, admindb)         │
│ - Redis (cache, sessions)                     │
│ - ORM (SQLAlchemy)                             │
└────────────────────────────────────────────────┘
```

### レイヤー間の責務

#### 1. Presentation Layer
- **責務**: ユーザーインターフェースの表示
- **技術**: React, Next.js, Tailwind CSS
- **特徴**: SSR/CSRのハイブリッド、クライアント状態管理

#### 2. BFF Layer
- **責務**: フロントエンド専用のバックエンドロジック
- **技術**: Next.js API Routes
- **特徴**:
  - バックエンドサービスへのプロキシ
  - JWT Cookie管理（httpOnly）
  - レスポンス変換とエラーハンドリング
  - セッション管理

#### 3. Application Layer
- **責務**: ビジネスロジックの実装
- **技術**: FastAPI, Pydantic
- **特徴**:
  - RESTful API提供
  - JWT認証・認可
  - サービス間通信
  - データ整合性の維持

#### 4. Data Layer
- **責務**: データの永続化とキャッシング
- **技術**: PostgreSQL, Redis
- **特徴**:
  - トランザクション管理
  - データベース分離（サービスごとに専用DB）
  - キャッシュ戦略
  - セッションストア

---

## 通信パターン

### 同期通信（HTTP/REST）

すべてのサービス間通信は同期的なHTTP RESTで実装されています。

```
User Frontend → [HTTP/REST] → Auth Service (JWT取得)
User Frontend → [HTTP/REST] → User API (プロフィール取得)
Admin Frontend → [HTTP/REST] → Admin API (ドキュメント処理)

すべてのバックエンドAPI → [HTTP/REST] → Auth Service (JWKS取得)
```

### 認証フロー

```
1. クライアント → BFF: ログイン要求
2. BFF → Auth Service: 認証要求（email, password）
3. Auth Service → authdb: ユーザー検証
4. Auth Service → BFF: JWT返却（access + refresh）
5. BFF: JWTをhttpOnly Cookieに設定
6. BFF → クライアント: 認証成功レスポンス
```

### API呼び出しフロー

```
1. クライアント → BFF: API要求（Cookie付き）
2. BFF: CookieからJWT抽出
3. BFF → Backend API: Authorization HeaderにJWT付与
4. Backend API: JWT検証（JWKS使用）
5. Backend API → Database: データ操作
6. Backend API → BFF: レスポンス
7. BFF → クライアント: レスポンス返却
```

---

## データフロー

### 認証データフロー

```
┌──────────────┐
│ User Browser │
└──────┬───────┘
       │ 1. POST /api/auth/login
       ▼
┌─────────────────┐
│ Frontend BFF    │
│ (Next.js)       │
└──────┬──────────┘
       │ 2. POST /auth/login
       ▼
┌─────────────────┐
│ Auth Service    │────→ authdb.users (検証)
│ (FastAPI)       │────→ Redis (session作成)
└──────┬──────────┘
       │ 3. JWT返却
       ▼
┌─────────────────┐
│ Frontend BFF    │
│ Set-Cookie:     │
│ access_token    │
│ refresh_token   │
└─────────────────┘
```

### プロフィールデータフロー

```
┌──────────────┐
│ User Browser │
└──────┬───────┘
       │ 1. GET /api/profile (Cookie付き)
       ▼
┌─────────────────┐
│ Frontend BFF    │
└──────┬──────────┘
       │ 2. GET /profile (JWT Header付き)
       ▼
┌─────────────────┐
│ User API        │────→ Redis (キャッシュチェック)
│ (FastAPI)       │────→ apidb.profiles (取得)
│                 │────→ Redis (キャッシュ更新)
└──────┬──────────┘
       │ 3. Profile JSON返却
       ▼
┌─────────────────┐
│ Frontend BFF    │
└──────┬──────────┘
       │ 4. Profile返却
       ▼
┌──────────────┐
│ User Browser │
└──────────────┘
```

---

## スケーラビリティ設計

### 水平スケーリング

各サービスはステートレスに設計されており、水平スケーリングが可能です。

```
┌────────────────┐
│ Load Balancer  │
└────────┬───────┘
         │
    ┌────┴────┬─────────┐
    │         │         │
┌───▼───┐ ┌──▼────┐ ┌──▼────┐
│ API 1 │ │ API 2 │ │ API 3 │
└───────┘ └───────┘ └───────┘
     │         │         │
     └────┬────┴────┬────┘
          │         │
      ┌───▼─────┐ ┌─▼──────┐
      │ Postgres│ │ Redis  │
      └─────────┘ └────────┘
```

### キャッシング戦略

1. **Redisキャッシュ**
   - プロフィールデータ（TTL: 300秒）
   - セッション情報（TTL: 3600秒）
   - JWKSキャッシュ（TTL: 600秒）

2. **データベースコネクションプール**
   - 各サービスで10-20コネクション保持
   - アイドルタイムアウト: 300秒

3. **CDN活用（将来）**
   - 静的アセットのキャッシング
   - エッジロケーションでの配信

---

## 障害対策

### 障害検知と復旧

```
┌─────────────────────────────────────────┐
│ Health Check Endpoints                  │
│ - /health (各サービス)                   │
│ - /ready (準備完了チェック)              │
└─────────────────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────────┐
│ Monitoring & Alerting                   │
│ - Docker Health Checks                  │
│ - ログ監視                               │
│ - メトリクス収集                          │
└─────────────────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────────┐
│ Auto Recovery                           │
│ - Docker自動再起動                       │
│ - サービスレベルRetry                    │
│ - Circuit Breaker（将来実装）           │
└─────────────────────────────────────────┘
```

### フォールバック戦略

1. **認証サービス障害時**
   - 既存JWT（有効期限内）で継続動作
   - Redisキャッシュから一時的に検証

2. **User API障害時**
   - Redisキャッシュからプロフィール取得
   - 読み取り専用モードで動作

3. **Redis障害時**
   - データベースから直接取得
   - セッション再生成

4. **PostgreSQL障害時**
   - レプリカへのフェイルオーバー（将来実装）
   - 読み取り専用モード

---

## 関連ドキュメント

- [マイクロサービス連携](./02-microservices-integration.md)
- [インフラ構成](./03-infrastructure.md)
- [技術スタック](./04-technology-stack.md)
- [サービス間通信](../08-integration/01-service-communication.md)
- [セキュリティ設計](../10-security/01-security-overview.md)

---

**最終更新**: 2025-09-30